{"version":3,"file":"plugins/plugin.iiif.js","mappings":"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","sources":["webpack://@internetarchive/bookreader/./src/BookReaderPlugin.js","webpack://@internetarchive/bookreader/./src/plugins/plugin.iiif.js"],"sourcesContent":["// @ts-check\n/** @typedef {import(\"./BookReader.js\").default} BookReader */\n\n/**\n * @template TOptions\n */\nexport class BookReaderPlugin {\n  /**\n   * @param {BookReader} br\n   */\n  constructor(br) {\n    /** @type {BookReader} */\n    this.br = br;\n    /** @type {TOptions} */\n    this.options;\n  }\n\n  /**\n   * @abstract\n   * @param {TOptions} options\n   **/\n  setup(options) {\n    this.options = Object.assign({}, this.options, options);\n  }\n\n  /** @abstract */\n  init() {}\n\n  /**\n   * @abstract\n   * @protected\n   * @param {import (\"./BookReader/PageContainer.js\").PageContainer} pageContainer\n   */\n  _configurePageContainer(pageContainer) {\n  }\n\n  /**\n   * @abstract\n   * @protected\n   * @param {JQuery<HTMLElement>} $toolbarElement\n   */\n  _configureToolbar($toolbarElement) {\n  }\n\n  /** @abstract @protected */\n  _bindNavigationHandlers() {}\n\n  /**\n   * @param {JQuery<HTMLElement>} $navBar\n   */\n  extendNavBar($navBar) {}\n}\n","// @ts-check\nimport { BookReaderPlugin } from '../BookReaderPlugin';\n\nconst BookReader = /** @type {typeof import('../BookReader').default} */(window.BookReader);\n\nexport class IiifPlugin extends BookReaderPlugin {\n  options = {\n    enabled: true,\n    /** @type {import('@iiif/presentation-3').Manifest | import('@iiif/presentation-2').Manifest} */\n    manifest: null,\n  }\n\n  setup(options) {\n    super.setup(options);\n    this.manifest = this.options.manifest;\n\n    if (this.options.enabled) {\n      Object.assign(this.br.options, this.load());\n    }\n  }\n\n  load() {\n    if (this.manifest[\"@context\"] == \"http://iiif.io/api/presentation/2/context.json\") {\n      const manifest = /** @type {import('@iiif/presentation-2').Manifest} */(this.manifest);\n      return this.manifestToBookReaderV2(manifest);\n    } else if (this.manifest[\"@context\"] == \"http://iiif.io/api/presentation/3/context.json\") {\n      const manifest = /** @type {import('@iiif/presentation-3').Manifest} */(this.manifest);\n      return this.manifestToBookReaderV3(manifest);\n    } else {\n      throw new Error(\"Unsupported IIIF context \" + this.manifest[\"@context\"]);\n    }\n  }\n\n  /**\n   * @param {import('@iiif/presentation-3').Manifest} manifest\n   */\n  manifestToBookReaderV3(manifest) {\n    /** @type {import('../BookReader/options.js').BookReaderOptions} */\n    const book = {\n      bookTitle: resolveInternationalString(manifest.label),\n      pageProgression: manifest.viewingDirection == \"right-to-left\" ? \"rl\" : \"lr\",\n      // numLeafs: manifest.items.length,\n      metadata: (manifest.metadata || []).map((metadata) => {\n        return {\n          label: resolveInternationalString(metadata.label),\n          value: resolveInternationalString(metadata.value),\n        };\n      }),\n      data: [],\n      /**\n       * @this {import('../BookReader.js').default}\n       */\n      getPageURI(pageIndex, reduce, rotate) {\n        const percent = Math.floor(100 * 1 / reduce);\n        const bodyArr = manifest.items[pageIndex].items[0].items[0].body;\n        const body = bodyArr instanceof Array ? bodyArr[0] : bodyArr;\n        const uri = body.service[0].id;\n        return `${uri}/full/pct:${percent}/0/default.jpg`;\n      },\n    };\n\n    if (manifest.viewingDirection == \"top-to-bottom\" || manifest.viewingDirection == \"bottom-to-top\") {\n      console.warn(\"Unsupported viewingDirection\", manifest.viewingDirection);\n    }\n\n    let spread = [];\n    manifest.items.forEach((item, index) => {\n      const bodyArr = manifest.items[index].items[0].items[0].body;\n      const body = bodyArr instanceof Array ? bodyArr[0] : bodyArr;\n      const uri = body.service[0].id;\n      /** @type {import('../BookReader/options.js').PageData} */\n      const pageData = {\n        uri,\n        width: item.width,\n        height: item.height,\n        pageNum: resolveInternationalString(item.label),\n      };\n      spread.push(pageData);\n      if (index % 2 == 0) {\n        book.data.push(spread);\n        spread = [];\n      }\n    });\n    if (spread.length > 0) {\n      book.data.push(spread);\n    }\n    return book;\n  }\n\n  /**\n   * @param {import('@iiif/presentation-2').Manifest} manifest\n   */\n  manifestToBookReaderV2(manifest) {\n    /** @type {import('../BookReader/options.js').BookReaderOptions} */\n    const book = {\n      bookTitle: manifest.label,\n      metadata: manifest.metadata,\n      thumbnail: manifest.thumbnail?.['@id'],\n      // numLeafs: manifest.sequences[0].canvases.length,\n      data: [],\n      /**\n       * @this {import('../BookReader.js').default}\n       */\n      getPageURI(pageIndex, reduce, rotate) {\n        const percent = Math.floor(100 * 1 / reduce);\n        const uri = manifest.sequences[0].canvases[pageIndex].images[0].resource.service['@id'];\n        return `${uri}/full/pct:${percent}/0/default.jpg`;\n      },\n    };\n\n    let spread = [];\n    manifest.sequences[0].canvases.forEach((canvas, index) => {\n      /** @type {import('../BookReader/options.js').PageData} */\n      const pageData = {\n        uri: canvas.images[0].resource.service['@id'],\n        width: canvas.width,\n        height: canvas.height,\n        pageNum: canvas.label,\n      };\n      spread.push(pageData);\n      if (index % 2 == 0) {\n        book.data.push(spread);\n        spread = [];\n      }\n    });\n    if (spread.length > 0) {\n      book.data.push(spread);\n    }\n    return book;\n  }\n}\n\n/**\n * @param {import('@iiif/presentation-3').InternationalString} internationalString\n */\nfunction resolveInternationalString(internationalString) {\n  const anyLang = Object.keys(internationalString)[0];\n  return (internationalString[navigator.language] || internationalString[anyLang])[0];\n}\n\nBookReader?.registerPlugin('iiif', IiifPlugin);\n"],"names":["BookReaderPlugin","br","_classCallCheck","this","options","key","value","Object","assign","pageContainer","$toolbarElement","$navBar","BookReader","window","IiifPlugin","_BookReaderPlugin","_this","_len","arguments","length","args","Array","_key","_callSuper","concat","enabled","manifest","_inherits","load","manifestToBookReaderV2","manifestToBookReaderV3","Error","book","bookTitle","resolveInternationalString","label","pageProgression","viewingDirection","metadata","map","data","getPageURI","pageIndex","reduce","rotate","percent","Math","floor","bodyArr","items","body","uri","service","id","console","warn","spread","forEach","item","index","pageData","width","height","pageNum","push","_manifest$thumbnail","thumbnail","sequences","canvases","images","resource","canvas","internationalString","anyLang","keys","navigator","language","registerPlugin"],"sourceRoot":""}